---
title: "International Severe Acute Respiratory and Emerging Infections Consortium (ISARIC)"
output:
  pdf_document:
    toc: no
    includes:
      in_header: header.tex
  html_document:
    df_print: paged
    number_sections: yes
    toc: yes
    toc_depth: 2
    toc_float:
      collapsed: no
urlcolor: blue
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)

library(tidyselect)
library(plyr)
library(tidyverse)
library(magrittr)
library(glue)
library(viridis)
library(ggupset)
library(sf)
library(rgeos)
library(rnaturalearth)
library(rnaturalearthdata)
library(magrittr)
library(binom)
library(fitdistrplus)
library(lubridate)
library(grid)
library(binom)
library(boot)
library(survival)
library(survminer)
library(broom)
library(taRifx)
library(gridExtra)

reprocess.data <- FALSE
verbose <- TRUE

# file locations

paths <- read_csv("paths.csv", col_names = F)

code.path <- paths[[which(paths$X1 == "code.path"), 2]]
data.path <- paths[[which(paths$X1 == "data.path"), 2]]
uk.data.dict.file <- paths[[which(paths$X1 == "uk.data.dict.file"), 2]]
row.data.dict.file <- paths[[which(paths$X1 == "row.data.dict.file"), 2]]
eot.data.dict.file <- paths[[which(paths$X1 == "eot.data.dict.file"), 2]]
rapid.data.dict.file <- paths[[which(paths$X1 == "rapid.data.dict.file"), 2]]
site.list.file <- paths[[which(paths$X1 == "site.list.file"), 2]]
uk.data.file <- paths[[which(paths$X1 == "uk.data.file"), 2]]
row.data.file <- paths[[which(paths$X1 == "row.data.file"), 2]]
eot.data.file <- paths[[which(paths$X1 == "eot.data.file"), 2]]
rapid.data.file <- paths[[which(paths$X1 == "rapid.data.file"), 2]]

ref.date <- as.Date(substr(uk.data.file, start = 6, stop  = 15))

# Source files

if(!(reprocess.data) & file.exists(glue("{code.path}/patient_data_{ref.date}.rda"))){
  load(glue("{code.path}/patient_data_{ref.date}.rda"))
} else {
  source(glue("{code.path}/process_data.R"))
}

source(glue("{code.path}/plot_functions.R"))


if(!(reprocess.data) & file.exists(glue("{code.path}/report_input_data_{ref.date}.rda"))){
  load(glue("{code.path}/report_input_data_{ref.date}.rda"))
} else {
  source(glue("{code.path}/generate_report_input.R"))
}





```

*A global federation of clinical research networks, providing a proficient, coordinated, and agile research response to outbreak-prone infectious diseases*


# COVID-19 Report: `r format(as.Date(substr(uk.data.file, start = 6, stop  = 15)), "%d %B %Y")` {-}

# Summary

```{r child = 'markdown/summary.Rmd'}
```
\newpage
# Patient Characteristics


**Figure 1**: Age and sex distribution of patients. Bar fills are outcome (death/discharge/ongoing care) at the time of report. 

```{r agepyramid, echo = FALSE}

age.pyramid(patient.data)

```
\newpage
**Figure 2**: Top: Frequency of symptoms seen at admission amongst COVID-19 patients. Bars are annotated with a fraction representing the number of patients presenting with this symptom over the number of patients for whom presence or absence of this symptom was recorded. Middle: The distribution of combinations of the four most common symptoms, amongst all patients for whom these data were recorded. Filled and empty circles below the x-axis indicate the presence or absence of each comorbidity. The "Any other" category contains all remaining symptoms in the top plot. Bottom: Heatmap for prevalance of pairwise combinations of symptoms. Fill colour reflects the proportion of patients reporting presence of both symptoms amongst those with recorded presence or absence of both.


```{r symptomcombos, echo=FALSE, out.width= "100%", fig.height=5, message=FALSE}
symptom.prevalence.plot(patient.data)
```
```{r symptomcombos2, echo=FALSE, out.width= "100%", fig.height=3, message=FALSE}
symptoms.upset(patient.data, 4)
```
```{r symptomcombos3, echo=FALSE, out.width= "100%", fig.height=5, message=FALSE}
symptom.heatmap(patient.data)
```

\newpage
**Figure 3**:  Top: Frequency of comorbidities seen at admission amongst COVID-19 patients. Bars are annotated with a fraction representing the number of patients presenting with this comorbidity over the number of patients for whom presence or absence of this comorbidity was recorded.  Bottom: The distribution of combinations of the four most common comorbidities, amongst all patients for whom these data were recorded. Filled and empty circles below the x-axis indicate the presence or absence of each comorbidity. The "Any other" category contains all remaining comorbidities in the top plot, and any other comorbidities recorded as free text by clinical staff.

```{r comorbcombos, echo=FALSE, out.width= "100%", fig.height=5, message=FALSE}
comorbidity.prevalence.plot(patient.data)

```
```{r comorbcombos2, echo=FALSE, out.width= "100%", fig.height=3, message=FALSE}
comorbidities.upset(patient.data, 4)

```

\newpage
# Variables by age

**Figure 4**: Comorbidities stratified by age group. Numbers on the plot show the number with the comorbidity and the number in the age group (numbers are not displayed if <5). Denominators vary between plots due to data completeness. 

```{r comorbbyage, echo=FALSE, out.width= "100%", fig.height=3, message=FALSE}
plot.comorb.by.age(patient.data)

```

**Figure 5**: Symptoms recorded at hospital presentation stratified by age group. Numbers on the plot show the number reporting the symptoms and the number in the age group (numbers are not displayed if <5). Denominators vary between plots due to data completeness. 

```{r sxbyage, echo=FALSE, out.width= "100%", fig.height=3, message=FALSE}
plot.sx.by.age(patient.data)

```

**Figure 6**: Box and whisker plots for observations at hospital presentation stratified by age group. Outliers are omitted.  N is the number of individuals included in the plot (this varies between plots due to data completeness).

```{r signsbyage, echo=FALSE, out.width= "100%", fig.height=3, message=FALSE}
plot.signs.by.age(patient.data)

```

**Figure 7**: Box and whisker plots for laboratory results within 24 hours of hospital presentation stratified by age group. Outliers are omitted.  N is the number of individuals included in the plot (this varies between plots due to data completeness).
ALT, Alanine transaminase; APTT, Activated partial thromboplastin time; CRP, C-reactive protein

```{r labsbyage, echo=FALSE, out.width= "100%", fig.height=3, message=FALSE}
plot.blood.results.by.age(patient.data)

```

\newpage
# Hospital stays and outcomes

**Figure 8**: Distribution of length of hospital stay, according to sex. This only includes cases with reported outcomes. The coloured areas indicate the kernel probability density of the observed data and the box plots show the mean and interquartile range of the variable of interest.

```{r  stay.by.sex, out.width= "80%"}

violin.sex.func(patient.data)
```

**Figure 9**: Distribution of length of hospital stay, according to patient age group. This only includes cases with reported outcomes. The coloured areas indicate the kernel probability density of the observed data and the box plots show the mean and interquartile range of the variable of interest.

```{r  stay.by.age, out.width= "80%"}

violin.age.func(patient.data)
```

\newpage
**Figure 10**: The distribution of patient status by number of days after admission. Patients with "Unknown" status have left the site at the time of report but have unknown outcomes due to missing data. Patients still on site at the time of report appear in the ongoing "ongoing care" for days which are in the future at that time. (For example, a patient admitted 7 days before the date of report and still on site at report would be categorised as "ongoing care" for days 8 and later.) The black line marks the end of 14 days; due to the cut-off, only a small number of patients appear in the "ongoing care" category left of this line.

```{r  timeline, out.width= "100%"}

status.by.time.after.admission(patient.data)
```

<!-- \newpage -->
<!-- **Figure 7**: Patient outcomes, stratified by oxygen saturations in room air on admission. -->

```{r outcomebysats, echo=FALSE, eval = FALSE}

#plot_outcome_saturations(patient.data)

```

\newpage
**Figure 11**: Patient numbers and outcomes by epidemiological week (of 2020) of admission (or, for patients infected in hospital, of symptom onset). The rightmost bar, marked with an asterisk, represents an incomplete week (due to the 14-day cutoff).

```{r recruitment3, echo=FALSE}

outcomes.by.admission.date(patient.data)

```

\newpage

# Treatment

**Figure 12**: Treatments used. This only includes patients for whom this information was recorded.

```{r treatment1, echo=FALSE}
treatment.use.plot(patient.data)
```

\newpage

**Figure 13**: The distribution of combinations of antimicrobial treatments and steroids administered during hospital stay, across all patients with completed hospital stay and recorded treatment data. Filled and empty circles below the x-axis indicate treatments that were and were not administered.

```{r treatment2, echo=FALSE}
treatment.upset(patient.data)
```

\newpage

# Intensive Care and High Dependency Unit Treatments

**Figure 14**: Treatments used amongst patients admitted to the ICU. This only includes patients for whom this information was recorded.


```{r treatment.icu, echo=FALSE}
treatment.use.plot.icu(patient.data)
```


\newpage

**Figure 15**: The distribution of combinations of treatments administered during ICU/HDU stay. Filled and empty circles below the x-axis indicate treatments that were and were not administered respectively.
<!-- The distribution of combinations of treatments administered during  hospital stay for patients who were admitted to an Intensive Care Unit . Filled and empty circles below the x-axis indicate treatments that were and were not administered. -->

```{r treatment2.icu, echo=FALSE}
icu.treatment.upset(patient.data)
```


\newpage
**Figure 16**: Distribution of lengths of stay for patients who were admitted to ICU/HDU: total length of stay for this group and length of stay within intensive care. This only includes cases with reported completed stays. The coloured areas indicate the kernel probability density of the observed data and the box plots show the mean and interquartile range of the variable of interest.

```{r icu_los, echo=FALSE}
icu.violin.plot(patient.data)
```

\newpage

# Statistical Analysis

**Figure 17**: Distribution of time from symptom onset to admission. The blue curve is the Gamma distribution fit to the data. The black dashed line indicates the position of the expected mean. Expected estimates, accounting for unobserved outcomes, are provided in the summary tables at the end of this report. 

```{r onset.admission, out.width = '80%'}

onset.adm.plot(patient.data)

```

\newpage

**Figure 18**: Distribution of time from admission to an outcome - either death or recovery (discharge). The blue curve is the Gamma distribution fit to the data. The black dashed line indicated the position of the expected mean.


```{r  adm.outcome, out.width = '80%'}

adm.outcome.plot(patient.data)

```

\newpage

**Figure 19**: Nonparametric probabilities of death (red curve) and recovery (green curve) over time. The black line indicates the case fatality ratio (black). The method used here considers all cases, irrespective of whether an outcome has been observed. For a completed epidemic, the curves for death and recovery meet. Estimates were derived using a nonparametric Kaplan-Meier–based method proposed by Ghani *et al.* (2005).


```{r outcomelines}

modified.km.plot(patient.data)

```

\newpage

# Country Comparisons

**Figure 20**: Number of sites per country.

```{r recruitment1, echo=FALSE}

sites.by.country(unembargoed.data)

```

\newpage

**Figure 21**: Distribution of patients by country and outcome

```{r recruitment2, echo=FALSE}

outcomes.by.country(patient.data)

```


\newpage

# Recruitment

**Figure 22**: Cumulative recruitment of participants, separated by whether follow-up is ongoing or an outcome has been recorded.  The first dashed black line indicates the exclusion date for this report: patients recruited after this date have not been included. The second black line is the exclusion date for next week's report.

``` {r recruitmentbyoutcome, echo=FALSE}

recruitment.dat.plot(unembargoed.data, today()-14)

```

\newpage

# Background

```{r child = 'markdown/background.Rmd'}
```

# Methods

```{r child = 'markdown/methods.Rmd'}
```

# Caveats

```{r child = 'markdown/caveats.Rmd'}
```

# Summary Tables
Proportions are presented in parantheses. Proportions have been rounded to two decimal places. 

```{r child = 'markdown/summarytables.Rmd'}
```

# ISARIC Team Members

```{r child = 'markdown/teammembers.Rmd'}
```

# References

```{r child = 'markdown/references.Rmd'}
```

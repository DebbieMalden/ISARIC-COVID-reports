---
title: "International Severe Acute Respiratory and Emerging Infections Consortium (ISARIC)"
output:
  html_document:
    df_print: paged
    number_sections: yes
    toc: yes
    toc_depth: 2
    toc_float:
      collapsed: no
  pdf_document:
    toc: no
    includes:
      in_header: header.tex
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)

library(plyr)
library(tidyverse)
library(glue)
library(viridis)
library(ggupset)
library(sf)
library(rgeos)
library(rnaturalearth)
library(rnaturalearthdata)
library(magrittr)
library(binom)
library(fitdistrplus)
library(lubridate)
library(grid)
library(binom)
library(boot)
library(survival)
library(survminer)
library(broom)

reprocess.data <- F

# file locations

paths <- read_csv("paths.csv", col_names = F)

code.path <- paths[[which(paths$X1 == "code.path"), 2]]
data.path <- paths[[which(paths$X1 == "data.path"), 2]]
data.dict.file <- paths[[which(paths$X1 == "data.dict.file"), 2]]
site.list.file <- paths[[which(paths$X1 == "site.list.file"), 2]]
uk.data.file <- paths[[which(paths$X1 == "uk.data.file"), 2]]
row.data.file <- paths[[which(paths$X1 == "row.data.file"), 2]]
eot.data.file <- paths[[which(paths$X1 == "eot.data.file"), 2]]

# Source files

if(!(reprocess.data) & file.exists(glue("{code.path}/patient_data_{today()}.rda"))){
  load(glue("{code.path}/patient_data_{today()}.rda"))
} else {
  source(glue("{code.path}/process_data.R"))
}

source(glue("{code.path}/plot_functions.R"))


if(!(reprocess.data) & file.exists(glue("{code.path}/report_input_data_{today()}.rda"))){
  load(glue("{code.path}/report_input_data_{today()}.rda"))
} else {
  source(glue("{code.path}/generate_report_input.R"))
}


```

*A global federation of clinical research networks, providing a proficient, coordinated, and agile research response to outbreak-prone infectious diseases*


# COVID-19 Report: `r format(as.Date(substr(uk.data.file, start = 6, stop  = 15)), "%d %B %Y")` {-}

# Summary

```{r child = 'markdown/summary.Rmd'}
```
\newpage
# Patient Characteristics


**Figure 1**: Age and sex distribution of patients. Bar fills are outcome (death/discharge/ongoing care) at the time of report. 

```{r agepyramid, echo = FALSE}

age.pyramid(patient.data)

```
\newpage
**Figure 2**: Top: Frequency of symptoms seen at admission amongst COVID-19 patients. Bottom: The distribution of combinations of the four most common symptoms, amongst all patients for whom this data was recorded. Filled and empty circles below the x-axis indicate the presence or absence of each comorbidity. The "Any other" category contains all remaining symptoms in the top plot.


```{r symptomcombos, echo=FALSE, out.width= "100%", fig.height=3, message=FALSE}
symptom.prevalence.plot(patient.data)
symptoms.upset(patient.data, 4)


```

\newpage
**Figure 3**:  Top: Frequency of comorbidities seen at admission amongst COVID-19 patients. Bottom: The distribution of combinations of the four most common comorbidities, amongst all patients for whom this data was recorded. Filled and empty circles below the x-axis indicate the presence or absence of each comorbidity. The "Any other" category contains all remaining comorbidities in the top plot, and any other comorbidities recorded as free text by clinical staff.

```{r comorbcombos, echo=FALSE, out.width= "100%", fig.height=3, message=FALSE}
comorbidity.prevalence.plot(patient.data)
comorbidities.upset(patient.data, 4)

```

\newpage
# Hospital stays and outcomes

**Figure 4**: Distribution of length of hospital stay, according to sex. This only includes cases with reported outcomes. The coloured areas indicate the kernel probability density of the observed data and the box plots show the mean and interquartile range of the variable of interest.

```{r  stay.by.sex, out.width= "80%"}

violin.sex.func(patient.data)
```

**Figure 5**: Distribution of length of hospital stay, according to patient age group. This only includes cases with reported outcomes. The coloured areas indicate the kernel probability density of the observed data and the box plots show the mean and interquartile range of the variable of interest.

```{r  stay.by.age, out.width= "80%"}

violin.age.func(patient.data)
```

\newpage
**Figure 6**: The distribution of patient status by number days after admission. Patients with "Unknown" status have left the site at the time of report but have unknown outcomes due to missing data. Patients with "Ongoing care" are still in site at the time of analysis. The black line marks the end of 14 days; due to the cut-off, only a small number of patients (those acquiring the infection in hospital) appear in the "ongoing care" category left of this line.

```{r  timeline, out.width= "100%"}

status.by.time.after.admission(patient.data)
```

\newpage
**Figure 7**: Patient numbers and outcomes by epidemiological week (of 2020) of admission (or, for patients infected in hospital, of symptom onset). The rightmost bar, marked with an asterisk, represents an incomplete week (due to the 14-day cutoff).

```{r recruitment3, echo=FALSE}

outcomes.by.admission.date(patient.data)

```
\newpage

# Treatment

**Figure 8**: Treatments used. This only includes patients where this information was recorded.

```{r treatment1, echo=FALSE}
treatment.use.plot(patient.data)
```

\newpage
**Figure 9**: The distribution of combinations of antimicrobial treatments and steroids administered during hospital stay, across all patients with completed hospital stay and recorded treatment data. Filled and empty circles below the x-axis indicate treatments that were and were not administered.

```{r treatment2, echo=FALSE}
treatment.upset(patient.data)
```

\newpage
# Intensive Care Unit Treatments

These figures include only the `r sum(patient.data$ICU.ever == 'TRUE', na.rm = T)` patients who were admitted to an Intensive Care Unit.

**Figure 10**: Treatments used. This only includes patients where this information was recorded.

```{r treatment.icu, echo=FALSE}
treatment.use.plot.icu(patient.data)
```
\newpage
**Figure 11**: The distribution of combinations of treatments administered during hospital stay for patients who were admitted to an Intensive Care Unit. Filled and empty circles below the x-axis indicate treatments that were and were not administered.

```{r treatment2.icu, echo=FALSE}
icu.treatment.upset(patient.data)
```
\newpage
**Figure 12** Distribution of lengths of stay for patients who were admitted to an Intensive Care Unit: total length of stay for this group and length of stay within Intensive Care. This only includes cases with reported completed stays. The coloured areas indicate the kernel probability density of the observed data and the box plots show the mean and interquartile range of the variable of interest.

```{r icu_los, echo=FALSE}
icu.violin.plot(patient.data)
```

\newpage

# Statistical Analysis

**Figure 13**: Distribution of time from symptom onset to admission. The blue curve is the Gamma distribution fit to the data. The black dashed line indicates the position of the expected mean. Expected estimates, accounting for unobserved outcomes, are provided in the summary tables at the end of this report. 

```{r onset.admission, out.width = '100%'}

onset.adm.plot(patient.data)

```


**Figure 14**: Distribution of time from admission to an outcome - either death or recovery (discharge). The blue curve is the Gamma distribution fit to the data. The black dashed line indicated the position of the expected mean.


```{r  adm.outcome, out.width = '80%'}

adm.outcome.plot(patient.data)

```

\newpage

**Figure 15**: Nonparametric probabilities of death (red curve) and recovery (green curve) over time. The black line indicates the case fatality ratio (black). The method used here considers all cases, irrespective of whether an outcome has been observed. For a completed epidemic, the curves for death and recovery meet. Estimates were derived using a nonparametric Kaplan-Meierâ€“based method proposed by Ghani *et al.* (2005).


```{r outcomelines}

modified.km.plot(patient.data)

```
\newpage

# Country Comparisons

**Figure 16**: Number of sites per country.

```{r recruitment1, echo=FALSE}

sites.by.country(unembargoed.data)

```

**Figure 17**: Distribution of patients by country and outcome

```{r recruitment2, echo=FALSE}

outcomes.by.country(patient.data)

```
\newpage

# Recruitment

**Figure 18**: Cumulative recruitment of participants, separated by whether follow-up is ongoing or an outcome has been recorded.  The first dashed black line indicates the exclusion date for this report: patients recruited after this date have not been included. The second black line is the exclusion date for next week's report.

``` {r recruitmentbyoutcome, echo=FALSE}

recruitment.dat.plot(unembargoed.data, today()-14)

```

\newpage

# Background

```{r child = 'markdown/background.Rmd'}
```

# Methods

```{r child = 'markdown/methods.Rmd'}
```

# Caveats

```{r child = 'markdown/caveats.Rmd'}
```

# Summary Tables

```{r child = 'markdown/summarytables.Rmd'}
```

# ISARIC Team Members

```{r child = 'markdown/teammembers.Rmd'}
```

# References

```{r child = 'markdown/references.Rmd'}
```

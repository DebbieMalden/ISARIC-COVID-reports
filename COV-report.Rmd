---
title: "International Severe Acute Respiratory and Emerging Infections Consortium (ISARIC)"
output:
  html_document:
    df_print: paged
    number_sections: yes
    toc: yes
    toc_depth: 2
    toc_float:
      collapsed: no
  pdf_document:
    toc: yes
    toc_depth: '2'
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)

library(plyr)
library(tidyverse)
library(glue)
library(viridis)
library(ggupset)
library(sf)
library(rgeos)
library(rnaturalearth)
library(rnaturalearthdata)
library(magrittr)
library(binom)
library(fitdistrplus)
library(lubridate)
library(grid)
library(binom)
library(boot)
library(survival)
library(survminer)
library(broom)

reprocess.data <- T

# file locations

paths <- read_csv("paths.csv", col_names = F)

code.path <- paths[[which(paths$X1 == "code.path"), 2]]
data.path <- paths[[which(paths$X1 == "data.path"), 2]]
data.dict.file <- paths[[which(paths$X1 == "data.dict.file"), 2]]
site.list.file <- paths[[which(paths$X1 == "site.list.file"), 2]]
uk.data.file <- paths[[which(paths$X1 == "uk.data.file"), 2]]
row.data.file <- paths[[which(paths$X1 == "row.data.file"), 2]]
eot.data.file <- paths[[which(paths$X1 == "eot.data.file"), 2]]

# Source files

if(!(reprocess.data) & file.exists(glue("{code.path}/patient_data_{today()}.rda"))){
  load(glue("{code.path}/patient_data_{today()}.rda"))
} else {
  source(glue("{code.path}/process_data.R"))
}

source(glue("{code.path}/plot_functions.R"))

if(!(reprocess.data) & file.exists(glue("{code.path}/report_input_data_{today()}.rda"))){
  load(glue("{code.path}/report_input_data_{today()}.rda"))
} else {
  source(glue("{code.path}/generate_report_input.R"))
}

```

<!-- <p style="font-family: times, serif; font-size:24pt> **International Severe Acute Respiratory and Emerging Infections Consortium (ISARIC)**</p> -->

<!-- <f style="font-family: times, serif; font-size:11pt; font-style:italic"> - A global federation of clinical research networks, providing a proficient, coordinated, and agile research response to outbreak-prone infectious diseases</f> -->


<f style="font-family: times, serif; font-size:11pt; font-style:italic"> - A global federation of clinical research networks, providing a proficient, coordinated, and agile research response to outbreak-prone infectious diseases</f>

# COVID-19 Report: 27 March 2020 {-}

# Summary

```{r child = 'markdown/summary.Rmd'}
```

# Patient Characteristics


**Figure 1**: Age and sex distribution of patients. Bar fills are outcome (death/discharge/ongoing care) at the time of report. 

```{r agepyramid, echo = FALSE}

age.pyramid(patient.data)

```

**Figure 2**: Top: Frequency of symptoms seen at admission amongst COVID-19 patients. Bottom: The distribution of combinations of the four most common symptoms, amongst all patients for whom this data was recorded. Filled and empty circles below the x-axis indicate the presence or absence of each comorbidity. The "Any other" category contains all remaining symptoms in the top plot.


```{r symptomcombos, echo=FALSE, out.width= "100%", fig.height=3, message=FALSE}
symptom.prevalence.plot(patient.data)
symptoms.upset(patient.data, 4)


```


**Figure 3**:  Top: Frequency of comorbidities seen at admission amongst COVID-19 patients. Bottom: The distribution of combinations of the four most common comorbidities, amongst all patients for whom this data was recorded. Filled and empty circles below the x-axis indicate the presence or absence of each comorbidity. The "Any other" category contains all remaining comorbidities in the top plot, and any other comorbidities recorded as free text by clinical staff.

```{r comorbcombos, echo=FALSE, out.width= "100%", fig.height=3, message=FALSE}
comorbidity.prevalence.plot(patient.data)
comorbidities.upset(patient.data, 4)

```

**Figure 4**: Distribution of length of hospital stay, according to sex. This only includes cases with reported outcomes. The coloured areas indicate the kernel probability density of the observed data and the box plots show the mean and interquartile range of the variable of interest.

```{r  stay.by.sex, out.width= "80%"}

violin.sex.func(patient.data)
```

**Figure 5**: Distribution of length of hospital stay, according to patient age group. This only includes cases with reported outcomes. The coloured areas indicate the kernel probability density of the observed data and the box plots show the mean and interquartile range of the variable of interest.

```{r  stay.by.age, out.width= "80%"}

violin.age.func(patient.data)
```


<!-- **Figure 7**: Estimated hospital fatality ratio based on patients with complete outcome data, showing changes to estimate over time. Shaded area represents 95% confidence interval. Methods from Wu *et al.*(2020). -->

<!-- ```{r out.width= "80%"} -->

<!-- hospital.fatality.ratio(patient.data)$plt -->

<!-- ``` -->

**Figure 6**: Patient numbers and outcomes by epidemiological week (of 2020) of admission (or, for patients infected in hospital, of symptom onset). The rightmost bar, marked with an asterisk, represents an incomplete week (due to the embargo date) rather than a genuine decline in cases.

```{r recruitment3, echo=FALSE}

outcomes.by.admission.date(patient.data)

```


# Treatment

**Figure 7**: Treatments used. This only includes patients where this information was recorded.

```{r treatment1, echo=FALSE}
treatment.use.plot(patient.data)
```


**Figure 8**: The distribution of combinations of antimicrobial treatments and steroids administered during hospital stay, across all patients with completed hospital stay and recorded treatment data. Filled and empty circles below the x-axis indicate the presence or absence of each symptoms.

```{r treatment2, echo=FALSE}
treatment.upset(patient.data)
```


# Statistical Analysis

<!-- **Figure 9**: Survival analysis for length of hospital stay by sex. The y-axis shows the probability of missing discharge (i.e. remaining in hospital) at any given time. The shaded areas around the Kaplan-Meier curves are 95% confidence limits. Cases still in hospital are indicated by tick marks. A p-value less than 0.05 is an indication of a significant difference in duration of hospital stay by sex. -->


```{r survival, out.width= "80%", eval=FALSE}

#survival.plot.func(data)$plt

```
 


**Figure 9**: Distribution of time from symptom onset to admission. The blue curve is the Gamma distribution fit to the data. The black dashed line indicates the position of the expected mean. Expected estimates, accounting for unobserved outcomes, are provided in the summary tables at the end of this report. 

```{r onset.admission, out.width = '80%'}

onset.adm.plot(patient.data)

```


**Figure 10**: Distribution of time from admission to an outcome - either death or recovery (discharge). The blue curve is the Gamma distribution fit to the data. The black dashed line indicated the position of the expected mean.


```{r  adm.outcome, out.width = '80%'}

adm.outcome.plot(patient.data)

```



**Figure 11**: Nonparametric probabilities of death (red curve) and recovery (green curve) over time. The black line indicates the case fatality ratio (black). The method used here considers all cases, irrespective of whether an outcome has been observed. For a completed epidemic, the curves for death and recovery meet. Estimates were derived using a nonparametric Kaplan-Meierâ€“based method proposed by Ghani *et al.* (2005).


```{r outcomelines}

modified.km.plot(patient.data)

```


# Country Comparisons

**Figure 12**: Number of sites per country.

```{r recruitment1, echo=FALSE}

sites.by.country(unembargoed.data)

```

**Figure 13**: Distribution of patients by country and outcome

```{r recruitment2, echo=FALSE}

outcomes.by.country(patient.data)

```

# Recruitment

**Figure 14**: Cumulative recruitment of participants, separated by whether follow-up is ongoing or an outcome has been recorded.  The dashed black line indicates the exclusion date for this report: patients recruited after this date have not been included

``` {r recruitmentbyoutcome, echo=FALSE}

recruitment.dat.plot(unembargoed.data, today()-14)

```

# Background

```{r child = 'markdown/background.Rmd'}
```

# Methods

```{r child = 'markdown/methods.Rmd'}
```

# Caveats

```{r child = 'markdown/caveats.Rmd'}
```

# Summary Tables

```{r child = 'markdown/summarytables.Rmd'}
```

# ISARIC Team Members

```{r child = 'markdown/teammembers.Rmd'}
```

# References

```{r child = 'markdown/references.Rmd'}
```
